#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ“± Patch: hide hero button block on scroll (mobile)"

# Immer aus dem web-Verzeichnis heraus arbeiten
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CSS_FILE="$ROOT_DIR/css/home.css"
JS_FILE="$ROOT_DIR/js/nav_autohide.js"

if [[ ! -f "$CSS_FILE" ]]; then
  echo "âŒ CSS file not found: $CSS_FILE"
  exit 1
fi

if [[ ! -f "$JS_FILE" ]]; then
  echo "âŒ JS file not found: $JS_FILE"
  exit 1
fi

ts="$(date +%Y%m%d_%H%M%S)"

# ------------------------------
# Backup
# ------------------------------
CSS_BACKUP="${CSS_FILE}.bak_${ts}"
JS_BACKUP="${JS_FILE}.bak_${ts}"

cp "$CSS_FILE" "$CSS_BACKUP"
cp "$JS_FILE" "$JS_BACKUP"

echo "ðŸ§· Backup CSS: $CSS_BACKUP"
echo "ðŸ§· Backup JS : $JS_BACKUP"

# ------------------------------
# CSS: Klassen fÃ¼r Hero-Hide
# ------------------------------
if grep -q "hero-hide-on-scroll" "$CSS_FILE"; then
  echo "â„¹ï¸ CSS already patched, skipping CSS append."
else
  cat >> "$CSS_FILE" << 'EOF'

/* ============================================================
   Mobile: hero intro button block should hide on scroll
   ============================================================ */
@media (max-width: 900px) {
  .hero-hide-on-scroll {
    transition: max-height 0.35s ease, opacity 0.3s ease, margin 0.3s ease;
    overflow: hidden;
  }

  .hero-hide-on-scroll--hidden {
    max-height: 0;
    opacity: 0;
    margin-bottom: 0;
  }
}
EOF
  echo "âœ… CSS patch appended to css/home.css"
fi

# ------------------------------
# JS: Hero auf Scroll einklappen
# ------------------------------
if grep -q "setupHeroHideOnScroll" "$JS_FILE"; then
  echo "â„¹ï¸ JS already patched, skipping JS append."
else
  cat >> "$JS_FILE" << 'EOF'

/* ============================================================
   Hero auto-hide on scroll (mobile)
   ============================================================ */
(function () {
  "use strict";

  function setupHeroHideOnScroll() {
    // Versuche verschiedene mÃ¶gliche Hero-Container zu finden
    var hero =
      document.querySelector(".home-hero") ||
      document.querySelector(".hero") ||
      document.querySelector(".intro-block") ||
      document.querySelector(".intro") ||
      document.querySelector(".hero-section") ||
      document.querySelector(".landing-buttons") ||
      document.querySelector(".top-buttons");

    if (!hero) return;

    hero.classList.add("hero-hide-on-scroll");

    var lastStateHidden = false;

    window.addEventListener("scroll", function () {
      var y = window.pageYOffset || document.documentElement.scrollTop;

      // Schwellwert: ab ~80px ScrollhÃ¶he einklappen
      var shouldHide = y > 80;

      if (shouldHide !== lastStateHidden) {
        if (shouldHide) {
          hero.classList.add("hero-hide-on-scroll--hidden");
        } else {
          hero.classList.remove("hero-hide-on-scroll--hidden");
        }
        lastStateHidden = shouldHide;
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupHeroHideOnScroll);
  } else {
    setupHeroHideOnScroll();
  }
})();
EOF

  echo "âœ… JS patch appended to js/nav_autohide.js"
fi

echo "ðŸŽ‰ Done. Reload the page on your phone to test."
